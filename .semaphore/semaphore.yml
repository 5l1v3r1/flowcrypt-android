version: v1.0
name: FlowCrypt Android App

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:

  - name: Build
    execution_time_limit:
      minutes: 7
    task:
      env_vars:
        - name: SEMAPHORE_GIT_DIR
          value: /home/semaphore/git/flowcrypt-android
        - name: SDK_ARCHIVE
          value: sdk-tools-linux-4333796.zip
        - name: ANDROID_SDK_ROOT
          value: /home/semaphore/Android/Sdk
      jobs:
        - name: Build
          commands:
            - sudo rm -rf ~/.rbenv ~/.phpbrew
            - mkdir -p $ANDROID_SDK_ROOT
            - sudo apt-get -q update && sudo apt-get -q install -y libc6-i386 lib32stdc++6 lib32gcc1 lib32ncurses5 lib32z1
            - bash -c '! [ -e "~/Android/$SDK_ARCHIVE" ] && wget https://dl.google.com/android/repository/$SDK_ARCHIVE -P ~/Android/'
            - unzip -qq ~/Android/$SDK_ARCHIVE -d $ANDROID_SDK_ROOT && rm ~/Android/$SDK_ARCHIVE
            - export PATH="$ANDROID_SDK_ROOT/tools:$ANDROID_SDK_ROOT/tools/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
            - echo "yes" | sdkmanager --licenses > /dev/null
            - sdkmanager --list
            - (while sleep 3; do echo "y"; done) | sdkmanager "build-tools;26.0.1" "platforms;android-24" "extras;google;m2repository" "extras;android;m2repository" "platform-tools" "emulator" "system-images;android-24;google_apis;armeabi-v7a" > /dev/null
            - echo -ne '\n' | avdmanager -v create avd -n semaphore-android-dev -k "system-images;android-24;google_apis;armeabi-v7a" --tag "google_apis" --abi "armeabi-v7a"
            - checkout && cd ~/git/flowcrypt-android
            - ./gradlew assembleProdDebug
            - mkdir ~/testable && mv ./FlowCrypt/build/outputs/apk/prod/debug/FlowCrypt-prod-debug.apk ~/testable/FlowCrypt-prod-debug.apk
            - cd ~ && cache store android-testable-$SEMAPHORE_GIT_SHA testable

  - name: Test
    task:
      jobs:
        - name: Find testable folder
          commands:
            - cache has_key android-testable-$SEMAPHORE_GIT_SHA
            - cache restore android-testable-$SEMAPHORE_GIT_SHA
            - ls ~/testable

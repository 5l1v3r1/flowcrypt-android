version: v1.0
name: FlowCrypt Android App

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:

  - name: Build
    execution_time_limit:
      minutes: 10
    task:
      env_vars:
        - name: SEMAPHORE_GIT_DIR
          value: /home/semaphore/git/flowcrypt-android
        - name: SDK_ARCHIVE
          value: sdk-tools-linux-4333796.zip
        - name: ANDROID_SDK_ROOT
          value: /home/semaphore/Android/Sdk
      jobs:
        - name: Build
          commands:
            - sudo rm -rf ~/.rbenv ~/.phpbrew
#            - sudo apt-get -q update && sudo apt-get -q install -y libc6-i386 lib32stdc++6 lib32gcc1 lib32ncurses5 lib32z1
            - checkout && cd ~
            - $SEMAPHORE_GIT_DIR/script/ci-install-android-sdk.sh

            - export GRADLE_CACHE_KEY=gradle-cache-$SEMAPHORE_GIT_BRANCH-$(checksum $SEMAPHORE_GIT_DIR/build.gradle)-$(checksum $SEMAPHORE_GIT_DIR/FlowCrypt/build.gradle)
            - export GRADLE_CACHE_KEY_MASTER=gradle-cache-master-$(checksum $SEMAPHORE_GIT_DIR/build.gradle)-$(checksum $SEMAPHORE_GIT_DIR/FlowCrypt/build.gradle)
            - cache restore $GRADLE_CACHE_KEY,$GRADLE_CACHE_KEY_MASTER
            - ( cd $SEMAPHORE_GIT_DIR && ./gradlew assembleProdDebug )
            - find ~/.gradle/caches/ -name "*.lock" -type f -delete # https://medium.com/cirruslabs/mastering-gradle-caching-and-incremental-builds-37eb1af7fcde
            # cache refreshed on build file conf change below. Also && refreshed android sdk cache, because gradle may install deps there
            - cache has_key $GRADLE_CACHE_KEY || ( cache store $GRADLE_CACHE_KEY .gradle && cache store $ANDROID_SDK_CACHE_KEY Android )

            - mkdir ~/testable && mv $SEMAPHORE_GIT_DIR/FlowCrypt/build/outputs/apk/prod/debug/FlowCrypt-prod-debug.apk ~/testable/FlowCrypt-prod-debug.apk
            - cache store android-testable-$SEMAPHORE_GIT_SHA testable


  - name: Test
    task:
      jobs:
        - name: Find testable folder
          commands:
            - cache has_key android-testable-$SEMAPHORE_GIT_SHA
            - cache restore android-testable-$SEMAPHORE_GIT_SHA
            - ls ~/testable/
            - du -sh ~/testable/*
